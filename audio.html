<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Audio</title>
    <link rel="stylesheet" href="https://gymburgdorf-ef23.github.io/helpers/basicstyle.css">
    <style>
        html {
            background-color: #444;
        }

        #buttons {
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
    <h1>Audio</h1>
    <audio src="audio/example1.mp3"></audio>
    <div id="buttons">
        <button id="startMicButton" onclick="startMic();">Start Microphone</button>
        <button id="stopMicButton" onclick="stopMic();" disabled>Stop Microphone</button>
        <button id="startFileButton" onclick="startFile();">Start Audio File</button>
        <button id="stopFileButton" onclick="stopFile();" disabled>Stop Audio File</button>
    </div>
    <div id="output-container">
        <svg id="output" viewBox="0 0 1000 10" xmlns="http://www.w3.org/2000/svg">

        </svg>
    </div>
    <script>

        // Setup

        let context, analyser, source
        let isplaying = false;
        const databuffer = new Float32Array(1024)
        const outputelem = document.querySelector("#output")

        function setUpAudioContext() {
            context = new AudioContext();
            analyser = context.createAnalyser()
            analyser.ftSize = 1024
        }

        // Use microphone (triggered by botton)

        async function startMic() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = false
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = true

            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            source = context.createMediaStreamSource(micStream);

            // TODO: Add slider to change gain
            const gainNode = new GainNode(context, { gain: 10 })
            source.connect(gainNode)
            gainNode.connect(analyser)

            isplaying = true;
            updateFrame()
        }

        // Stop using the microphone (triggered by botton)

        function stopMic() {
            isplaying = false;
            source.disconnect();

            document.querySelector("#startMicButton").disabled = false
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = false
            document.querySelector("#stopFileButton").disabled = true

            clearFrame();
        }

        // Use file (triggered by botton)

        function startFile() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = false

            const myAudio = document.querySelector('audio');
            myAudio.play()
            source = context.createMediaElementSource(myAudio);
            source.connect(analyser)
            analyser.connect(context.destination)
            myAudio.currentTime = 37;

            isplaying = true;
            updateFrame()
        }

        // Stop using the file (triggered by botton)

        function stopFile() {
            isplaying = false;

            source.disconnect();
            const myAudio = document.querySelector('audio');
            myAudio.pause();
            myAudio.currentTime = 0;

            document.querySelector("#startMicButton").disabled = false
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = false
            document.querySelector("#stopFileButton").disabled = true

            clearFrame();
        }

        // Update frame

        function showData(data) {
            outputelem.innerHTML = "";

            let sum = 0;
            data.forEach(d => sum += d);
            
            for (let i = 0; i < sum*10; i++) {
                let circle = document.createElement("circle");

                let red = 0;
                let green = 0;
                let blue = 0;

                circle.setAttribute("fill", `rgb(${red},${green},${blue})`)
                circle.setAttribute("r", 5)
                circle.setAttribute("cx", 11*(i) + 5)
                circle.setAttribute("cy", 5)
                outputelem.appendChild(circle);
            }

            // Debug
            outputelem.innerHTML += `<p><br>${data.join("<br>")}<br><br>${Math.max(...data)}<br>${sum}<p>`;
        }

        function updateFrame() {
            if (isplaying) {
                analyser.getFloatTimeDomainData(databuffer)
                data = databuffer.slice(0, 10);

                showData(data);

                // Let JS know that we want to run this function when the next frame is rendered
                requestAnimationFrame(updateFrame);
            }
        }

        function clearFrame() {
            showData([0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
        }

    </script>
</body>

</html>