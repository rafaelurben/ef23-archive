<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Audio</title>
    <link rel="stylesheet" href="https://gymburgdorf-ef23.github.io/helpers/basicstyle.css">
    <style>
        html {
            background-color: #444;
        }

        #buttons {
            margin-bottom: 16px;
        }
    </style>
</head>

<body>
    <h1>Audio experiment</h1>

    <audio src="audio/example1.mp3"></audio>
    <div id="buttons">
        <button id="startMicButton" onclick="startMic();">Start Microphone</button>
        <button id="stopMicButton" onclick="stopMic();" disabled>Stop Microphone</button>
        <button id="startFileButton" onclick="startFile();">Start Audio File</button>
        <button id="stopFileButton" onclick="stopFile();" disabled>Stop Audio File</button>
    </div>
    <div id="output-container">
        <svg id="output" viewBox="0 0 1000 10" xmlns="http://www.w3.org/2000/svg">

        </svg>
    </div>



    <!-- The magic begins here -->
    <script>

        // Setup

        let context, analyser, source
        let isplaying = false;
        const databuffer = new Float32Array(1024)
        const outputelem = document.querySelector("#output")

        function setUpAudioContext() {
            context = new AudioContext();
            analyser = context.createAnalyser()
            analyser.ftSize = 1024
        }
        
        // Utils

        function stopAudio() {
            isplaying = false;
            source.disconnect();

            document.querySelector("#startMicButton").disabled = false
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = false
            document.querySelector("#stopFileButton").disabled = true

            clearFrame();
        }

        // Button actions

        async function startMic() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = false
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = true

            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            source = context.createMediaStreamSource(micStream);

            // Amplify the input volume
            const gainNode = new GainNode(context, { gain: 2 })
            console.log(gainNode)
            source.connect(gainNode)
            gainNode.connect(analyser)

            isplaying = true;
            updateFrame()
        }

        function stopMic() {
            stopAudio();
        }

        function startFile() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = false

            const myAudio = document.querySelector('audio');
            myAudio.play()
            source = context.createMediaElementSource(myAudio);
            source.connect(analyser)
            analyser.connect(context.destination)
            myAudio.currentTime = 37;

            isplaying = true;
            updateFrame()
        }

        function stopFile() {
            stopAudio();

            const myAudio = document.querySelector('audio');
            myAudio.pause();
            myAudio.currentTime = 0;
        }

        // Visualization

        // The smoothing factor is used to make the visible volume go back a little bit slower when the volume suddenly decreases.
        let smoothing_factor = 0.9;

        // The value from the latest function call. (used for smoothing)
        let latest_value = 0;

        function showData(data) {
            outputelem.innerHTML = "";

            let sum = 0;
            data.forEach(d => sum += d);
            latest_value = Math.max(sum, latest_value*smoothing_factor)
            
            for (let i = 0; i < Math.min(latest_value*8, 90); i++) {
                let circle = document.createElement("circle");

                circle.setAttribute("fill", `hsl(${Math.max(130-(i*3), 0)},100%,35%)`)
                circle.setAttribute("r", 5)
                circle.setAttribute("cx", 11*(i) + 5)
                circle.setAttribute("cy", 5)
                outputelem.appendChild(circle);
            }

            // Without this line, JS doesn't rerender the SVG. I don't know why neither understand why this line changes anything.
            outputelem.innerHTML += "";

            // Debug
            // outputelem.innerHTML += `<p><br>${data.join("<br>")}<br><br>${Math.max(...data)}<br>${sum}<p>`;
        }

        function updateFrame() {
            if (isplaying) {
                analyser.getFloatTimeDomainData(databuffer)
                data = databuffer.slice(0, 10);

                showData(data);

                // Let JS know that we want to run this function when the next frame is rendered
                requestAnimationFrame(updateFrame);
            }
        }

        function clearFrame() {
            outputelem.innerHTML = "";
            latest_value = 0;
        }

    </script>
</body>

</html>