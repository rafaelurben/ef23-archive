<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Audio</title>
    <link rel="stylesheet" href="https://gymburgdorf-ef23.github.io/helpers/basicstyle.css">
    <style>
        html {
            background-color: #444;
        }
    </style>
</head>

<body>
    <h1>Audio</h1>
    <audio src="audio.mp3"></audio>
    <div id="buttons">
        <button id="startMicButton" onclick="startMic();">Start Microphone</button>
        <button id="stopMicButton" onclick="stopMic();" disabled>Stop Microphone</button>
        <button id="startFileButton" onclick="startFile();">Start Audio File</button>
        <button id="stopFileButton" onclick="stopFile();" disabled>Stop Audio File</button>
    </div>
    <div class="output"></div>
    <script>

        let context, analyser, source
        let isplaying = false;
        const databuffer = new Float32Array(1024)

        function setUpAudioContext() {
            context = new AudioContext();
            analyser = context.createAnalyser()
            analyser.ftSize = 1024
        }

        // Use microphone

        async function startMic() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = false
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = true

            const micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false })
            source = context.createMediaStreamSource(micStream);
            const gainNode = new GainNode(context, { gain: 10 })
            source.connect(gainNode)
            gainNode.connect(analyser)

            isplaying = true;
            updateFrame()
        }

        function stopMic() {
            isplaying = false;
            source.disconnect();

            document.querySelector("#startMicButton").disabled = false
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = false
            document.querySelector("#stopFileButton").disabled = true

            clearFrame();
        }

        // Use file

        function startFile() {
            setUpAudioContext()

            document.querySelector("#startMicButton").disabled = true
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = true
            document.querySelector("#stopFileButton").disabled = false

            const myAudio = document.querySelector('audio');
            myAudio.play()
            source = context.createMediaElementSource(myAudio);
            source.connect(analyser)
            analyser.connect(context.destination)
            myAudio.currentTime = 37;

            isplaying = true;
            updateFrame()
        }

        function stopFile() {
            isplaying = false;

            source.disconnect();
            const myAudio = document.querySelector('audio');
            myAudio.pause();
            myAudio.currentTime = 0;

            document.querySelector("#startMicButton").disabled = false
            document.querySelector("#stopMicButton").disabled = true
            document.querySelector("#startFileButton").disabled = false
            document.querySelector("#stopFileButton").disabled = true

            clearFrame();
        }

        // Update frame

        function showData(data) {
            console.log(Math.max(...data));
            document.querySelector(".output").textContent = data.join(", ");
        }

        function updateFrame() {
            if (isplaying) {
                analyser.getFloatTimeDomainData(databuffer)

                data = databuffer.slice(0, 10);
                showData(data);

                requestAnimationFrame(updateFrame);
            }
        }

        function clearFrame() {
            showData([0,0,0,0,0,0,0,0,0,0]);
        }

    </script>
</body>

</html>